{% extends "base.html" %}

{% block title %}用户管理 - {{ system_title }}{% endblock %}

{% block content %}
<div class="card">
    <h2>用户管理</h2>
    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">返回后台</a>
        <a href="{{ url_for('download_user_template') }}" class="btn" download>下载导入模板</a>
        <button onclick="document.getElementById('import-form').style.display='block'" class="btn btn-success">批量导入</button>
        <button onclick="deleteSelected()" class="btn btn-danger">批量删除</button>
    </div>

    <form id="import-form" method="POST" action="{{ url_for('import_users') }}" enctype="multipart/form-data" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
        <div class="form-group">
            <label>选择CSV文件</label>
            <input type="file" name="file" accept=".csv" required>
        </div>
        <button type="submit" class="btn btn-success">上传导入</button>
        <button type="button" onclick="document.getElementById('import-form').style.display='none'" class="btn btn-secondary">取消</button>
    </form>

    <table>
        <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAll(this)"></th>
                <th>学工号</th>
                <th>姓名</th>
                <th>注册时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
                <td>{{ user.student_id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.created_at }}</td>
                <td>
                    <button onclick="showRenameModal({{ user.id }}, '{{ user.name }}')" class="btn" style="padding: 4px 8px; font-size: 12px;">更名</button>
                    <form method="POST" action="{{ url_for('reset_user_password', user_id=user.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;" onclick="return confirm('确定重置该用户密码为学工号吗？')">重置密码</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

function deleteSelected() {
    const checked = document.querySelectorAll('input[name="user_ids"]:checked');
    if (checked.length === 0) {
        alert('请选择要删除的用户');
        return;
    }
    if (confirm(`确定删除选中的 ${checked.length} 个用户吗？此操作不可恢复！`)) {
        del_users_form = document.createElement("form");
        del_users_form.method = 'POST';
        del_users_form.action = "{{ url_for('delete_users') }}";
        checked.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.name = 'user_ids';
            input.value = checkbox.value;
            input.checked = true
            del_users_form.appendChild(input);
        });
        document.body.appendChild(del_users_form);
        del_users_form.submit();
    }
}

// Rename modal functionality
function showRenameModal(userId, currentName) {
    document.getElementById('rename-user-id').value = userId;
    document.getElementById('current-name').textContent = currentName;
    document.getElementById('new-name').value = currentName;
    document.getElementById('rename-form').action = `/admin/users/${userId}/rename`;
    document.getElementById('rename-modal').style.display = 'block';
    document.getElementById('new-name').focus();
    document.getElementById('new-name').select();
}

function closeRenameModal() {
    document.getElementById('rename-modal').style.display = 'none';
}

function submitRename() {
    const newName = document.getElementById('new-name').value.trim();
    if (!newName) {
        alert('新姓名不能为空');
        return false;
    }

    const form = document.getElementById('rename-form');
    form.submit();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('rename-modal');
    if (event.target === modal) {
        closeRenameModal();
    }
}

// Handle ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeRenameModal();
    }
    if (event.key === 'Enter' && document.getElementById('rename-modal').style.display === 'block') {
        submitRename();
    }
}
</script>

<!-- Rename Modal -->
<div id="rename-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 400px; max-width: 90%; border-radius: 4px;">
        <h3 style="margin-top: 0;">更名用户</h3>
        <p>当前姓名: <strong id="current-name"></strong></p>

        <form id="rename-form" method="POST" onsubmit="return false;">
            <input type="hidden" id="rename-user-id" name="user_id">

            <div class="form-group">
                <label for="new-name">新姓名:</label>
                <input type="text" id="new-name" name="new_name" required style="width: 100%; padding: 8px; margin-top: 5px;">
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button type="button" onclick="closeRenameModal()" class="btn btn-secondary">取消</button>
                <button type="button" onclick="submitRename()" class="btn btn-success" style="margin-left: 8px;">确认更名</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
