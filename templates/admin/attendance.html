{% extends "base.html" %}
{% block title %}签到管理 - {{ system_title }}{% endblock %}
{% block content %}
<div class="card">
    <h2>签到管理</h2>
    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">返回后台</a>
        <button onclick="document.getElementById('create-form').style.display='block'" class="btn btn-success">发起签到</button>
    </div>
    <div id="create-form" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 4px;">
        <h3>发起签到活动</h3>
        <form method="POST" action="{{ url_for('create_attendance_session') }}">
            <div class="form-group">
                <label>开始时间（留空表示立即开始）</label>
                <input type="datetime-local" class="form-control" name="start_time">
            </div>
            <div class="form-group">
                <label>结束时间（留空表示10分钟后）</label>
                <input type="datetime-local" class="form-control" name="end_time">
            </div>
            <button type="submit" class="btn btn-success">创建签到</button>
            <button type="button" onclick="document.getElementById('create-form').style.display='none'" class="btn btn-secondary">取消</button>
        </form>
    </div>
    <table>
        <thead>
            <tr><th>活动码</th><th>开始时间</th><th>结束时间</th><th>签到人数/总人数</th><th>状态</th><th>操作</th></tr>
        </thead>
        <tbody>
            {% for session in sessions %}
            <tr>
                <td><strong>{{ session.activity_code }}</strong></td>
                <td>{{ session.start_time }}</td>
                <td>{{ session.end_time }}</td>
                <td>{{ session.checked_in_count }} / {{ session.total_users }}</td>
                <td>{% if session.is_active %}<span style="color: #27ae60;">进行中</span>{% else %}<span style="color: #95a5a6;">已结束</span>{% endif %}</td>
                <td>
                    <a href="{{ url_for('attendance_records', session_id=session.id) }}" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">查看记录</a>
                    {% if session.is_active %}
                    <form method="POST" action="{{ url_for('end_attendance_session', session_id=session.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">结束签到</button>
                    </form>
                    {% endif %}
                    <form method="POST" action="{{ url_for('delete_attendance_session', session_id=session.id) }}" style="display: inline; margin-left: 5px;" onsubmit="return confirm('确定要删除此签到活动吗？此操作将删除该活动的所有签到记录、二维码及积分记录，且不可恢复。');">
                        <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; background: #c0392b;">删除活动</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
